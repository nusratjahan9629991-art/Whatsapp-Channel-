<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>WhatsApp Channel — Full App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- TensorFlow.js for AR Face Filter -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <style>
        /* The existing CSS from WhatsApp Channel UI remains the same */
        :root{--wa-green:#25D366; --wa-dark:#075E54; --bg:#f6fbf8; --card:#ffffff; --muted:#6b7280; --shadow: 0 6px 20px rgba(10,20,15,0.06);}
        *{box-sizing:border-box}
        html,body{height:100%}
        body{font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#f2fbf6 0%, #eef9f3 100%);color:#0f172a;margin:0;}
        .app{min-height:100vh;display:flex;flex-direction:column}
        .app-header{position:fixed;top:12px;left:50%;transform:translateX(-50%);width:min(980px,96%);height:64px;background:linear-gradient(180deg,var(--card),#f8fff9);border-radius:14px;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;box-shadow:var(--shadow);z-index:1200}
        .brand{display:flex;align-items:center;gap:12px}
        .brand .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--wa-green),#19b35a);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
        .brand .title{font-weight:600;font-size:1.05rem;color:#082427}
        .header-actions{display:flex;align-items:center;gap:8px}
        .wallet-chip{background:linear-gradient(90deg,rgba(37,211,102,0.1),rgba(7,94,84,0.03));border:1px solid rgba(7,94,84,0.06);padding:8px 12px;border-radius:999px;display:flex;align-items:center;gap:8px;cursor:pointer}
        .viewport{margin-top:96px;margin-bottom:96px;display:flex;justify-content:center}
        .shell{width:min(980px,96%);background:transparent;border-radius:12px;display:flex;gap:18px}
        .content{flex:1;min-height:60vh;}
        .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
        .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;width:min(980px,96%);height:74px;background:linear-gradient(180deg,#ffffff,#f7fff8);border-radius:14px;display:flex;align-items:center;justify-content:space-around;box-shadow:var(--shadow);z-index:1200}
        .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);gap:4px;padding:6px 10px;border-radius:10px;cursor:pointer}
        .nav-item.active{color:var(--wa-dark);background:rgba(37,211,102,0.08)}
        .section{display:none}
        .section.active{display:block}
        .floating{position:fixed;left:50%;transform:translateX(-50%) translateY(110%);bottom:0;width:min(980px,96%);height:84vh;background:linear-gradient(180deg,#ffffff,#f5fff9);border-radius:16px;box-shadow:0 25px 60px rgba(6,30,20,0.12);z-index:1300;transition:transform .35s cubic-bezier(.2,.9,.3,1);display:flex;flex-direction:column;overflow:hidden}
        .floating.active{transform:translateX(-50%) translateY(6%)}
        .floating .head{padding:12px 16px;background:linear-gradient(180deg,#f6fff6,#f0fff2);display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(6,30,20,0.04)}
        .floating .body{padding:16px;overflow:auto;flex:1}
        #regOverlay {position: fixed; inset: 0; background: rgba(40, 40, 40, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999;}
        #regCard {background: white; padding: 28px; border-radius: 16px; text-align: center; max-width: 90%; width: 400px;}
        #regCard h2 {font-size: 1.3rem; line-height: 1.5; font-weight: 700; color: var(--wa-dark); margin-bottom: 24px;}
        #registerBtn {background-color: var(--wa-green); color: white; border: none; padding: 12px 48px; border-radius: 999px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s;}
        #skipBtn {background: transparent; border: none; color: var(--wa-green); font-weight: 600; cursor: pointer; margin-top: 16px; font-size: 1rem;}
        .chat-list-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .chat-list-item:hover { background: #f6fbf8; }
        .chat-list-item .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--wa-green); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        .chat-container{display:flex; flex-direction:column; height:100%;}
        .chat-messages{flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column-reverse;}
        .message-bubble{padding:8px 14px; border-radius:18px; margin-bottom:8px; max-width:75%; word-wrap:break-word; font-size: 0.95rem; line-height: 1.4;}
        .message-bubble.sent{background-color: var(--wa-green); color:white; align-self:flex-end;}
        .message-bubble.received{background-color:#f0f0f0; color:black; align-self:flex-start;}
        .message-bubble img, .message-bubble video { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .chat-input{display:flex; align-items: center; padding:10px; border-top:1px solid #eee; background: #fff;}
        
        /* --- নতুন যুক্ত করা স্টাইল (ভিডিও কলের জন্য) --- */
        #videoCallContainer, #incomingCallContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; backdrop-filter: blur(5px); }
        #videoGrid { display: flex; flex-wrap: wrap; gap: 10px; width: 95%; height: 80%; justify-content: center; align-items: center; }
        #videoGrid video { max-width: 48%; height: auto; object-fit: cover; border-radius: 12px; background: #222; }
        #overlayCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10000; }
        #incomingCallBox { background: #fff; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <!-- Registration and Main App HTML remains the same -->
    <div id="regOverlay">...</div>
    <div class="app">
        <header class="app-header" id="mainHeader">
            <!-- Header content remains the same, including call buttons -->
            <div class="brand">...</div>
            <div class="header-actions">
                <button class="btn" id="audioCallBtn"><i class="bi bi-telephone-fill fs-5"></i></button>
                <button class="btn" id="videoCallBtn"><i class="bi bi-camera-video-fill fs-5"></i></button>
                <div class="wallet-chip" id="headerWalletChip">...</div>
            </div>
        </header>
        <main class="viewport">...</main>
        <nav class="bottom-nav" id="mainNav">...</nav>
        
        <!-- All floating pages from the original UI remain -->
        <div class="floating" id="earningApp">...</div>
        <div class="floating" id="inboxPage">...</div>
        <div class="floating" id="chatWindowPage">
            <div class="head">
                <button class="btn btn-link backFloating"><i class="bi bi-arrow-left"></i></button>
                <div style="font-weight:700" id="chattingWith">Chat</div>
                <div class="ms-auto d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-success" id="chatAudioCallBtn"><i class="bi bi-telephone-fill"></i></button>
                    <button class="btn btn-sm btn-success" id="chatVideoCallBtn"><i class="bi bi-camera-video-fill"></i></button>
                </div>
            </div>
            <div class="body p-0">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input">
                        <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                        <button class="btn btn-link" id="attachFileBtn"><i class="bi bi-paperclip fs-4"></i></button>
                        <button class="btn btn-success ms-2" id="sendMessageBtn"><i class="bi bi-send-fill"></i></button>
                        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
                    </div>
                </div>
            </div>
        </div>
        <div class="floating" id="randomPage">...</div>
    </div>
    
    <!-- --- নতুন যুক্ত করা HTML (ভিডিও কলের UI এর জন্য) --- -->
    <div id="videoCallContainer">
        <canvas id="overlayCanvas"></canvas>
        <div id="videoGrid">
            <video id="remoteVideo" autoplay></video>
            <video id="localVideo" autoplay muted></video>
        </div>
        <button id="endCallBtn" class="btn btn-danger mt-3">End Call</button>
    </div>

    <div id="incomingCallContainer">
        <div id="incomingCallBox">
            <h3 id="callerId">Incoming Call...</h3>
            <p>You have a video call.</p>
            <button id="acceptCallBtn" class="btn btn-success me-2">Accept</button>
            <button id="declineCallBtn" class="btn btn-danger">Decline</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, query, limitToLast, off, remove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBufKt1I2nnKIdqBYzLmuGwNIv2rWbFJUE",
          authDomain: "whatsapp-channel-chat.firebaseapp.com",
          projectId: "whatsapp-channel-chat",
          storageBucket: "whatsapp-channel-chat.appspot.com",
          messagingSenderId: "906974342849",
          appId: "1:906974342849:web:aa9d7db7aaa69ed2da2e40",
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', () => {
            // Existing state variables
            let currentUserNumber;
            let currentChatId;
            let currentFriendNumber; // নতুন ভ্যারিয়েবল: বর্তমানে কার সাথে চ্যাট হচ্ছে
            let currentMessagesRef;
            // ... (বাকি সব UI ভ্যারিয়েবল আগের মতই থাকবে) ...
            
            // --- ALL APP LOGIC (UI, Navigation, Earning etc.) REMAINS THE SAME ---
            // ... (এখানে আগের UI এর সম্পূর্ণ জাভাস্ক্রিপ্ট কোডটি থাকবে) ...


            // --- CHAT LOGIC ( আগের মতোই, শুধু কল বাটন যুক্ত হবে) ---
            const openChatWith = (friendNumber) => {
                currentFriendNumber = friendNumber; // বন্ধুর নম্বর সেভ করি
                const chatId = [currentUserNumber, friendNumber].sort().join('_');
                currentChatId = chatId;
                document.getElementById('chattingWith').innerText = friendNumber;
                
                set(ref(database, `users/${currentUserNumber}/chats/${friendNumber}`), { chatId: chatId, lastSeen: Date.now() });
                set(ref(database, `users/${friendNumber}/chats/${currentUserNumber}`), { chatId: chatId, lastSeen: Date.now() });
                
                openFloatingPage('chatWindowPage');
                loadMessages(chatId);
            };

            // ... (বাকি চ্যাট ফাংশন গুলো আগের মতই থাকবে) ...
            
            
            // --- WebRTC Video Call Logic (দ্বিতীয় কোড থেকে আনা হয়েছে এবং ইন্টিগ্রেট করা হয়েছে) ---
            let localStream, peerConnection;
            const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
            let callRef;

            // চ্যাট উইন্ডো থেকে ভিডিও কল শুরু করা
            document.getElementById('chatVideoCallBtn').addEventListener('click', () => {
                if (currentFriendNumber) {
                    startCall(currentFriendNumber, true); // true for video
                } else {
                    alert("Please select a chat to start a call.");
                }
            });
            
            // অডিও কলের জন্য একই ফাংশন ব্যবহার করা যেতে পারে (আপাতত এটি ভিডিও কলের মতোই কাজ করবে)
            document.getElementById('chatAudioCallBtn').addEventListener('click', () => {
                 if (currentFriendNumber) {
                    startCall(currentFriendNumber, false); // false for audio-only
                } else {
                    alert("Please select a chat to start a call.");
                }
            });


            async function startCall(friendNumber, isVideo) {
                const callChatId = [currentUserNumber, friendNumber].sort().join('_');
                callRef = ref(database, `calls/${callChatId}`);

                peerConnection = new RTCPeerConnection(config);
                localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
                
                const candidatesCollection = ref(database, `calls/${callChatId}/candidates/${currentUserNumber}`);
                peerConnection.onicecandidate = e => e.candidate && set(push(candidatesCollection), e.candidate.toJSON());
                onChildAdded(ref(database, `calls/${callChatId}/candidates/${friendNumber}`), snap => {
                    if (peerConnection.remoteDescription) peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                await set(callRef, { offer: { sdp: offer.sdp, type: offer.type }, from: currentUserNumber, to: friendNumber });
                
                onValue(callRef, async (snap) => {
                    const data = snap.val();
                    if (data && data.answer && !peerConnection.currentRemoteDescription) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                        document.getElementById('videoCallContainer').style.display = 'flex';
                        if (isVideo) loadFaceModel();
                    }
                }, { onlyOnce: true });
            }
            
            // ইনকামিং কল শোনার জন্য
            const userCallRef = ref(database, 'calls');
            onChildAdded(userCallRef, (snap) => {
                const callData = snap.val();
                if (callData && callData.to === currentUserNumber && callData.offer) {
                    const callChatId = snap.key;
                    callRef = ref(database, `calls/${callChatId}`);
                    
                    document.getElementById('callerId').innerText = `${callData.from} is calling...`;
                    document.getElementById('incomingCallContainer').style.display = 'flex';

                    document.getElementById('acceptCallBtn').onclick = async () => {
                        document.getElementById('incomingCallContainer').style.display = 'none';
                        peerConnection = new RTCPeerConnection(config);
                        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); // Assume incoming call is video
                        document.getElementById('localVideo').srcObject = localStream;
                        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                        peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
                        
                        const candidatesCollection = ref(database, `calls/${callChatId}/candidates/${currentUserNumber}`);
                        peerConnection.onicecandidate = e => e.candidate && set(push(candidatesCollection), e.candidate.toJSON());
                        onChildAdded(ref(database, `calls/${callChatId}/candidates/${callData.from}`), cSnap => {
                            if (peerConnection.remoteDescription) peerConnection.addIceCandidate(new RTCIceCandidate(cSnap.val()));
                        });

                        await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        await set(callRef, { ...callData, answer: { sdp: answer.sdp, type: answer.type } });
                        document.getElementById('videoCallContainer').style.display = 'flex';
                        loadFaceModel();
                    };
                    
                    document.getElementById('declineCallBtn').onclick = () => {
                        document.getElementById('incomingCallContainer').style.display = 'none';
                        remove(callRef);
                    };
                }
            });

            document.getElementById('endCallBtn').onclick = () => {
                document.getElementById('videoCallContainer').style.display = 'none';
                if (peerConnection) { peerConnection.close(); peerConnection = null; }
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                if(callRef) remove(callRef);
                if (window.arLoopId) cancelAnimationFrame(window.arLoopId);
            };

            // --- AR Face Filter Logic (দ্বিতীয় কোড থেকে আনা হয়েছে) ---
            const overlayCanvas = document.getElementById('overlayCanvas');
            const ctx = overlayCanvas.getContext('2d');
            const glassesImg = new Image();
            glassesImg.src = 'https://i.ibb.co/bB15w6s/glasses.png';
            let model;

            async function loadFaceModel() {
                if (!model) model = await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh);
                resizeCanvas(); window.addEventListener('resize', resizeCanvas);
                drawFaceFilters();
            }
            
            function resizeCanvas(){ overlayCanvas.width = window.innerWidth; overlayCanvas.height = window.innerHeight; }

            async function drawFaceFilters() {
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                const videos = [document.getElementById('localVideo'), document.getElementById('remoteVideo')];
                for (let video of videos) {
                    if (video.readyState >= 2 && video.srcObject) {
                        const predictions = await model.estimateFaces({ input: video, returnTensors: false, flipHorizontal: false });
                        predictions.forEach(pred => {
                            // ... AR drawing logic remains the same ...
                        });
                    }
                }
                window.arLoopId = requestAnimationFrame(drawFaceFilters);
            }
            
            // Initial App Setup
            // ... (UI update and user setup logic from original script) ...

        });
    </script>
</body>
</html>
